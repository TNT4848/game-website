<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cube Platformer</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

#gameContainer {
    position: relative;
    width: 800px;
    height: 600px;
    border: 4px solid #2c3e50;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

canvas {
    background: linear-gradient(to bottom, #87CEEB, #98FB98);
    display: block;
}

.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    z-index: 10;
}

.screen.hidden {
    display: none;
}

h1 {
    font-size: 4em;
    margin-bottom: 20px;
    text-shadow: 3px 3px 0 #000;
    color: #f1c40f;
}

h2 {
    font-size: 2.5em;
    margin-bottom: 30px;
    text-shadow: 2px 2px 0 #000;
    color: #e74c3c;
}

.menu {
    background: rgba(44, 62, 80, 0.95);
    padding: 40px;
    border-radius: 20px;
    border: 4px solid #f1c40f;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
}

button {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 15px 30px;
    margin: 10px;
    font-size: 1.2em;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid #f1c40f;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    min-width: 200px;
    font-weight: bold;
}

button:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    background: linear-gradient(45deg, #f39c12, #e67e22);
}

button:active {
    transform: translateY(-1px);
}

/* Improved Level Selector */
.level-selector {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.level-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.level-card {
    width: 80px;
    height: 80px;
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
    position: relative;
    overflow: hidden;
}

.level-card:hover {
    transform: scale(1.1);
    border-color: #f1c40f;
}

.level-card.locked {
    background: linear-gradient(45deg, #7f8c8d, #95a5a6);
    cursor: not-allowed;
    opacity: 0.6;
}

.level-card.available {
    background: linear-gradient(45deg, #27ae60, #2ecc71);
    cursor: pointer;
}

.level-card.current {
    background: linear-gradient(45deg, #f1c40f, #f39c12);
    transform: scale(1.1);
    border-color: #e74c3c;
    box-shadow: 0 0 20px #f1c40f;
}

.level-card.completed {
    background: linear-gradient(45deg, #3498db, #2980b9);
}

.level-number {
    font-size: 1.8em;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.level-stats {
    font-size: 0.7em;
    opacity: 0.9;
    margin-top: 2px;
}

.level-preview {
    margin: 20px 0;
    padding: 15px;
    background: rgba(52, 73, 94, 0.8);
    border-radius: 10px;
    border: 2px solid #f1c40f;
    min-width: 300px;
}

.level-preview h3 {
    color: #f1c40f;
    margin-bottom: 10px;
}

.level-preview p {
    margin: 5px 0;
    font-size: 1em;
}

.controls {
    background: rgba(52, 73, 94, 0.8);
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    border: 2px solid #f1c40f;
}

.controls h3 {
    color: #f1c40f;
    margin-bottom: 15px;
    text-shadow: 1px 1px 0 #000;
}

.controls p {
    margin: 5px 0;
    font-size: 1.1em;
}

.stats {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(44, 62, 80, 0.9);
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #f1c40f;
    color: white;
    font-size: 1.1em;
    z-index: 5;
    backdrop-filter: blur(5px);
}

.coin {
    color: #f1c40f;
    font-weight: bold;
}

.health {
    color: #e74c3c;
    font-weight: bold;
}

.level-complete {
    background: rgba(39, 174, 96, 0.95);
    border-color: #27ae60;
}

.level-failed {
    background: rgba(231, 76, 60, 0.95);
    border-color: #c0392b;
}

.progress-bar {
    width: 300px;
    height: 20px;
    background: #34495e;
    border-radius: 10px;
    margin: 20px 0;
    border: 2px solid #f1c40f;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(45deg, #f1c40f, #f39c12);
    width: 0%;
    transition: width 0.3s ease;
}

.particle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #f1c40f;
    border-radius: 50%;
    pointer-events: none;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.floating {
    animation: float 3s ease-in-out infinite;
}

.glow {
    text-shadow: 0 0 10px #f1c40f, 0 0 20px #f1c40f, 0 0 30px #f1c40f;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.rotating {
    animation: rotate 2s linear infinite;
}

/* Mobile responsiveness */
@media (max-width: 850px) {
    #gameContainer {
        width: 95vw;
        height: 95vh;
        max-width: 600px;
        max-height: 400px;
    }
    
    h1 { font-size: 2.5em; }
    h2 { font-size: 1.8em; }
    
    .menu {
        padding: 20px;
        margin: 10px;
    }
    
    button {
        padding: 12px 20px;
        font-size: 1em;
        min-width: 150px;
    }
    
    .level-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .level-card {
        width: 70px;
        height: 70px;
    }
}
</style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <!-- Main Menu -->
    <div id="mainMenu" class="screen">
        <div class="menu floating">
            <h1 class="glow">CUBE PLATFORMER</h1>
            <div class="controls">
                <h3>CONTROLS</h3>
                <p>ü†î ü†ñ Arrow Keys: Move</p>
                <p>Space: Jump</p>
                <p>Down + Space: Jump through platforms</p>
                <p>R: Restart Level</p>
                <p>M: Menu</p>
            </div>
            <button onclick="startGame()">START GAME</button>
            <button onclick="showLevelSelect()">LEVEL SELECT</button>
            <button onclick="showInstructions()">INSTRUCTIONS</button>
        </div>
    </div>
    
    <!-- Level Select -->
    <div id="levelSelect" class="screen hidden">
        <div class="menu">
            <div class="level-selector">
                <h2>SELECT LEVEL</h2>
                <div class="level-preview">
                    <h3 id="previewTitle">Level 1: Tutorial</h3>
                    <p id="previewDesc">Learn the basics of cube platforming</p>
                    <p>Coins: <span id="previewCoins">3</span> | Enemies: <span id="previewEnemies">0</span></p>
                </div>
                <div class="level-grid" id="levelGrid"></div>
                <div>
                    <button onclick="loadSelectedLevel()">PLAY LEVEL</button>
                    <button onclick="showMainMenu()">BACK</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div id="instructions" class="screen hidden">
        <div class="menu">
            <h2>HOW TO PLAY</h2>
            <div class="controls">
                <p>üéØ Collect all coins to complete each level</p>
                <p>‚¨áÔ∏è Hold DOWN while jumping to pass through platforms</p>
                <p>‚ù§Ô∏è Avoid enemies and hazards</p>
                <p>üö© Reach the flag to finish</p>
                <p>‚≠ê Complete levels to unlock new ones</p>
                <p>üíé Find hidden areas for bonus points!</p>
            </div>
            <button onclick="showMainMenu()">BACK</button>
        </div>
    </div>
    
    <!-- Level Complete -->
    <div id="levelComplete" class="screen hidden">
        <div class="menu level-complete">
            <h2>LEVEL COMPLETE! üéâ</h2>
            <p>Coins Collected: <span id="coinsCollected">0</span>/<span id="totalCoins">0</span></p>
            <p>Time: <span id="levelTime">0</span>s</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <button onclick="nextLevel()">NEXT LEVEL</button>
            <button onclick="restartLevel()">PLAY AGAIN</button>
            <button onclick="showLevelSelect()">LEVEL SELECT</button>
        </div>
    </div>
    
    <!-- Game Over -->
    <div id="gameOver" class="screen hidden">
        <div class="menu level-failed">
            <h2>GAME OVER üíÄ</h2>
            <p>Better luck next time!</p>
            <button onclick="restartLevel()">TRY AGAIN</button>
            <button onclick="showLevelSelect()">LEVEL SELECT</button>
            <button onclick="showMainMenu()">MAIN MENU</button>
        </div>
    </div>
    
    <!-- In-game Stats -->
    <div id="stats" class="stats hidden">
        <div>Level: <span id="currentLevel">1</span></div>
        <div>Coins: <span id="coinCount" class="coin">0</span></div>
        <div>Health: <span id="healthCount" class="health">100</span></div>
        <div>Time: <span id="timeCount">0</span>s</div>
    </div>
</div>

<script>
// Game Constants
const TILE_SIZE = 40;
const GRAVITY = 0.5;
const PLAYER_JUMP = -12;
const PLAYER_SPEED = 5;

// Game State
let currentLevel = 1;
let selectedLevel = 1;
let player = { x: 50, y: 300, width: 35, height: 35, velX: 0, velY: 0, jumping: false, health: 100, rotation: 0 };
let coins = [];
let enemies = [];
let platforms = [];
let jumpThroughPlatforms = [];
let levelComplete = false;
let gameOver = false;
let levelStartTime = 0;
let coinsCollected = 0;
let totalCoins = 0;
let canJumpThrough = false;

// Canvas Setup
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Level Definitions
const levels = [
    { // Level 1 - Tutorial
        name: "Tutorial",
        description: "Learn the basics of cube platforming",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 200, height: 20 },
            { x: 400, y: 350, width: 200, height: 20 }
        ],
        coins: [
            { x: 150, y: 350, width: 20, height: 20 },
            { x: 450, y: 300, width: 20, height: 20 },
            { x: 700, y: 420, width: 20, height: 20 }
        ],
        enemies: [],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 430, width: 30, height: 70 }
    },
    { // Level 2 - Jump Through Practice
        name: "Platform Master",
        description: "Practice jumping through platforms",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 100, height: 20 },
            { x: 300, y: 350, width: 100, height: 20 },
            { x: 500, y: 300, width: 100, height: 20 },
            { x: 200, y: 250, width: 100, height: 20 }
        ],
        coins: [
            { x: 150, y: 350, width: 20, height: 20 },
            { x: 350, y: 300, width: 20, height: 20 },
            { x: 550, y: 250, width: 20, height: 20 },
            { x: 250, y: 200, width: 20, height: 20 }
        ],
        enemies: [
            { x: 400, y: 480, width: 30, height: 20, speed: 2, direction: 1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 430, width: 30, height: 70 }
    },
    { // Level 3 - Mixed Platforms
        name: "Dual Platforms",
        description: "Mix of solid and jump-through platforms",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 },
            { x: 200, y: 300, width: 100, height: 20 },
            { x: 500, y: 200, width: 100, height: 20 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 80, height: 20 },
            { x: 350, y: 350, width: 80, height: 20 },
            { x: 600, y: 250, width: 80, height: 20 }
        ],
        coins: [
            { x: 140, y: 350, width: 20, height: 20 },
            { x: 240, y: 250, width: 20, height: 20 },
            { x: 390, y: 300, width: 20, height: 20 },
            { x: 540, y: 150, width: 20, height: 20 },
            { x: 640, y: 200, width: 20, height: 20 }
        ],
        enemies: [
            { x: 300, y: 480, width: 30, height: 20, speed: 2, direction: 1 },
            { x: 500, y: 480, width: 30, height: 20, speed: 2, direction: -1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 150, width: 30, height: 70 }
    },
    { // Level 4 - Moving Jump-Through
        name: "Moving Platforms",
        description: "Jump-through platforms that move",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 100, height: 20, moving: true, moveX: 200, speed: 1 },
            { x: 400, y: 350, width: 100, height: 20, moving: true, moveX: 200, speed: 1.5 },
            { x: 200, y: 250, width: 100, height: 20 }
        ],
        coins: [
            { x: 150, y: 350, width: 20, height: 20 },
            { x: 450, y: 300, width: 20, height: 20 },
            { x: 250, y: 200, width: 20, height: 20 },
            { x: 600, y: 400, width: 20, height: 20 }
        ],
        enemies: [
            { x: 350, y: 480, width: 30, height: 20, speed: 3, direction: 1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 430, width: 30, height: 70 }
    },
    { // Level 5 - Precision Jumping
        name: "Precision Challenge",
        description: "Requires precise jump timing",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 50, y: 400, width: 80, height: 20 },
            { x: 200, y: 400, width: 80, height: 20 },
            { x: 350, y: 400, width: 80, height: 20 },
            { x: 500, y: 400, width: 80, height: 20 },
            { x: 650, y: 400, width: 80, height: 20 },
            { x: 150, y: 300, width: 80, height: 20 },
            { x: 400, y: 300, width: 80, height: 20 },
            { x: 600, y: 200, width: 80, height: 20 }
        ],
        coins: [
            { x: 90, y: 350, width: 20, height: 20 },
            { x: 240, y: 350, width: 20, height: 20 },
            { x: 390, y: 350, width: 20, height: 20 },
            { x: 540, y: 350, width: 20, height: 20 },
            { x: 690, y: 350, width: 20, height: 20 },
            { x: 190, y: 250, width: 20, height: 20 },
            { x: 440, y: 250, width: 20, height: 20 },
            { x: 640, y: 150, width: 20, height: 20 }
        ],
        enemies: [
            { x: 100, y: 480, width: 30, height: 20, speed: 2, direction: 1 },
            { x: 400, y: 480, width: 30, height: 20, speed: 2, direction: -1 },
            { x: 700, y: 480, width: 30, height: 20, speed: 2, direction: 1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 150, width: 30, height: 70 }
    },
    { // Level 6 - Vertical Ascension
        name: "Sky High",
        description: "Climb to new heights",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 100, height: 20 },
            { x: 100, y: 300, width: 100, height: 20 },
            { x: 100, y: 200, width: 100, height: 20 },
            { x: 300, y: 350, width: 100, height: 20 },
            { x: 300, y: 250, width: 100, height: 20 },
            { x: 500, y: 400, width: 100, height: 20 },
            { x: 500, y: 300, width: 100, height: 20 },
            { x: 500, y: 200, width: 100, height: 20 }
        ],
        coins: [
            { x: 150, y: 350, width: 20, height: 20 },
            { x: 150, y: 250, width: 20, height: 20 },
            { x: 150, y: 150, width: 20, height: 20 },
            { x: 350, y: 300, width: 20, height: 20 },
            { x: 350, y: 200, width: 20, height: 20 },
            { x: 550, y: 350, width: 20, height: 20 },
            { x: 550, y: 250, width: 20, height: 20 },
            { x: 550, y: 150, width: 20, height: 20 }
        ],
        enemies: [
            { x: 200, y: 480, width: 30, height: 20, speed: 2, direction: 1 },
            { x: 400, y: 480, width: 30, height: 20, speed: 2, direction: -1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 150, width: 30, height: 70 }
    },
    { // Level 7 - Maze Runner
        name: "Platform Maze",
        description: "Navigate through the platform maze",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 },
            { x: 0, y: 0, width: 50, height: 500 },
            { x: 750, y: 0, width: 50, height: 500 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 600, height: 20 },
            { x: 100, y: 200, width: 600, height: 20 },
            { x: 100, y: 300, width: 100, height: 20 },
            { x: 300, y: 300, width: 100, height: 20 },
            { x: 500, y: 300, width: 100, height: 20 },
            { x: 200, y: 100, width: 100, height: 20 },
            { x: 400, y: 100, width: 100, height: 20 },
            { x: 600, y: 100, width: 100, height: 20 }
        ],
        coins: [
            { x: 150, y: 350, width: 20, height: 20 },
            { x: 350, y: 350, width: 20, height: 20 },
            { x: 550, y: 350, width: 20, height: 20 },
            { x: 250, y: 250, width: 20, height: 20 },
            { x: 450, y: 250, width: 20, height: 20 },
            { x: 650, y: 250, width: 20, height: 20 },
            { x: 250, y: 50, width: 20, height: 20 },
            { x: 450, y: 50, width: 20, height: 20 },
            { x: 650, y: 50, width: 20, height: 20 }
        ],
        enemies: [
            { x: 200, y: 480, width: 30, height: 20, speed: 3, direction: 1 },
            { x: 400, y: 480, width: 30, height: 20, speed: 3, direction: -1 },
            { x: 600, y: 480, width: 30, height: 20, speed: 3, direction: 1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 50, width: 30, height: 70 }
    },
    { // Level 8 - Complex Movement
        name: "Moving Madness",
        description: "Platforms moving in all directions",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 100, height: 20, moving: true, moveX: 300, speed: 2 },
            { x: 500, y: 350, width: 100, height: 20, moving: true, moveY: 100, speed: 1.5 },
            { x: 200, y: 250, width: 100, height: 20, moving: true, moveX: 200, speed: 1 },
            { x: 400, y: 150, width: 100, height: 20, moving: true, moveY: 100, speed: 2 }
        ],
        coins: [
            { x: 150, y: 350, width: 20, height: 20 },
            { x: 550, y: 300, width: 20, height: 20 },
            { x: 250, y: 200, width: 20, height: 20 },
            { x: 450, y: 100, width: 20, height: 20 },
            { x: 650, y: 400, width: 20, height: 20 }
        ],
        enemies: [
            { x: 300, y: 480, width: 30, height: 20, speed: 4, direction: 1 },
            { x: 600, y: 480, width: 30, height: 20, speed: 4, direction: -1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 100, width: 30, height: 70 }
    },
    { // Level 9 - Final Challenge
        name: "The Gauntlet",
        description: "Prove your platforming skills",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 50, y: 400, width: 80, height: 20 },
            { x: 200, y: 350, width: 80, height: 20 },
            { x: 350, y: 300, width: 80, height: 20 },
            { x: 500, y: 250, width: 80, height: 20 },
            { x: 650, y: 200, width: 80, height: 20 },
            { x: 100, y: 200, width: 80, height: 20 },
            { x: 250, y: 150, width: 80, height: 20 },
            { x: 400, y: 100, width: 80, height: 20 },
            { x: 550, y: 50, width: 80, height: 20 }
        ],
        coins: [
            { x: 90, y: 350, width: 20, height: 20 },
            { x: 240, y: 300, width: 20, height: 20 },
            { x: 390, y: 250, width: 20, height: 20 },
            { x: 540, y: 200, width: 20, height: 20 },
            { x: 690, y: 150, width: 20, height: 20 },
            { x: 140, y: 150, width: 20, height: 20 },
            { x: 290, y: 100, width: 20, height: 20 },
            { x: 440, y: 50, width: 20, height: 20 },
            { x: 590, y: 0, width: 20, height: 20 }
        ],
        enemies: [
            { x: 100, y: 480, width: 30, height: 20, speed: 5, direction: 1 },
            { x: 300, y: 480, width: 30, height: 20, speed: 5, direction: -1 },
            { x: 500, y: 480, width: 30, height: 20, speed: 5, direction: 1 },
            { x: 700, y: 480, width: 30, height: 20, speed: 5, direction: -1 }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 0, width: 30, height: 70 }
    },
    { // Level 10 - Boss Level
        name: "Final Showdown",
        description: "Face the ultimate challenge",
        platforms: [
            { x: 0, y: 500, width: 800, height: 100 }
        ],
        jumpThrough: [
            { x: 100, y: 400, width: 600, height: 20 },
            { x: 100, y: 300, width: 600, height: 20 },
            { x: 100, y: 200, width: 600, height: 20 },
            { x: 100, y: 100, width: 600, height: 20 }
        ],
        coins: [
            { x: 150, y: 350, width: 20, height: 20 },
            { x: 300, y: 350, width: 20, height: 20 },
            { x: 450, y: 350, width: 20, height: 20 },
            { x: 600, y: 350, width: 20, height: 20 },
            { x: 150, y: 250, width: 20, height: 20 },
            { x: 300, y: 250, width: 20, height: 20 },
            { x: 450, y: 250, width: 20, height: 20 },
            { x: 600, y: 250, width: 20, height: 20 },
            { x: 150, y: 150, width: 20, height: 20 },
            { x: 300, y: 150, width: 20, height: 20 },
            { x: 450, y: 150, width: 20, height: 20 },
            { x: 600, y: 150, width: 20, height: 20 }
        ],
        enemies: [
            { x: 200, y: 480, width: 40, height: 30, speed: 6, direction: 1, boss: true },
            { x: 400, y: 480, width: 40, height: 30, speed: 6, direction: -1, boss: true },
            { x: 600, y: 480, width: 40, height: 30, speed: 6, direction: 1, boss: true }
        ],
        start: { x: 50, y: 300 },
        flag: { x: 750, y: 50, width: 30, height: 70 }
    }
];

// Menu Functions
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.add('hidden');
    });
    document.getElementById(screenId).classList.remove('hidden');
}

function showMainMenu() {
    showScreen('mainMenu');
}

function showLevelSelect() {
    showScreen('levelSelect');
    updateLevelSelector();
}

function updateLevelSelector() {
    const levelGrid = document.getElementById('levelGrid');
    levelGrid.innerHTML = '';
    
    levels.forEach((level, index) => {
        const levelNum = index + 1;
        const card = document.createElement('div');
        card.className = 'level-card';
        card.innerHTML = `
            <div class="level-number">${levelNum}</div>
            <div class="level-stats">${level.coins.length} coins</div>
        `;
        
        if (levelNum === currentLevel) {
            card.classList.add('current');
        } else if (levelNum < currentLevel) {
            card.classList.add('completed');
        } else if (levelNum === currentLevel + 1) {
            card.classList.add('available');
        } else {
            card.classList.add('locked');
        }
        
        card.onclick = () => selectLevel(levelNum);
        card.onmouseenter = () => updateLevelPreview(levelNum);
        
        levelGrid.appendChild(card);
    });
    
    // Select first level by default
    selectLevel(selectedLevel);
}

function selectLevel(levelNum) {
    if (levelNum > currentLevel + 1) return;
    
    selectedLevel = levelNum;
    const level = levels[levelNum - 1];
    
    // Update all cards
    document.querySelectorAll('.level-card').forEach((card, index) => {
        const cardLevel = index + 1;
        card.classList.remove('current');
        if (cardLevel === levelNum) {
            card.classList.add('current');
        }
    });
    
    // Update preview
    updateLevelPreview(levelNum);
}

function updateLevelPreview(levelNum) {
    const level = levels[levelNum - 1];
    document.getElementById('previewTitle').textContent = `Level ${levelNum}: ${level.name}`;
    document.getElementById('previewDesc').textContent = level.description;
    document.getElementById('previewCoins').textContent = level.coins.length;
    document.getElementById('previewEnemies').textContent = level.enemies.length;
}

function loadSelectedLevel() {
    loadLevel(selectedLevel);
}

function showInstructions() {
    showScreen('instructions');
}

function startGame() {
    loadLevel(currentLevel);
}

function loadLevel(levelNum) {
    currentLevel = levelNum;
    const level = levels[levelNum - 1];
    
    // Reset game state
    player.x = level.start.x;
    player.y = level.start.y;
    player.velX = 0;
    player.velY = 0;
    player.health = 100;
    player.jumping = false;
    player.rotation = 0;
    
    coins = [...level.coins];
    enemies = level.enemies.map(enemy => ({ ...enemy }));
    platforms = level.platforms.map(platform => ({ 
        ...platform,
        originalX: platform.x,
        originalY: platform.y
    }));
    jumpThroughPlatforms = level.jumpThrough.map(platform => ({
        ...platform,
        originalX: platform.x,
        originalY: platform.y
    }));
    
    levelComplete = false;
    gameOver = false;
    coinsCollected = 0;
    totalCoins = coins.length;
    levelStartTime = Date.now();
    
    showScreen('gameCanvas');
    document.getElementById('stats').classList.remove('hidden');
    updateStats();
    
    // Start game loop
    gameLoop();
}

function nextLevel() {
    if (currentLevel < 10) {
        currentLevel++;
        loadLevel(currentLevel);
    } else {
        showMainMenu();
    }
}

function restartLevel() {
    loadLevel(currentLevel);
}

// Game Functions
function updateStats() {
    document.getElementById('currentLevel').textContent = currentLevel;
    document.getElementById('coinCount').textContent = coinsCollected;
    document.getElementById('healthCount').textContent = player.health;
    document.getElementById('timeCount').textContent = Math.floor((Date.now() - levelStartTime) / 1000);
}

function checkCollision(rect1, rect2) {
    return rect1.x < rect2.x + rect2.width &&
           rect1.x + rect1.width > rect2.x &&
           rect1.y < rect2.y + rect2.height &&
           rect1.y + rect1.height > rect2.y;
}

function updateGame() {
    // Update player
    player.velY += GRAVITY;
    player.x += player.velX;
    player.y += player.velY;
    player.rotation += player.velX * 0.1; // Rotate based on movement
    
    // Screen boundaries
    if (player.x < 0) player.x = 0;
    if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
    if (player.y > canvas.height) {
        player.health = 0;
        gameOver = true;
    }
    
    // Platform collision (solid platforms)
    let onGround = false;
    platforms.forEach(platform => {
        if (checkCollision(player, platform)) {
            // Top collision
            if (player.velY > 0 && player.y + player.height > platform.y && player.y < platform.y) {
                player.y = platform.y - player.height;
                player.velY = 0;
                player.jumping = false;
                onGround = true;
            }
            // Bottom collision
            else if (player.velY < 0 && player.y < platform.y + platform.height) {
                player.y = platform.y + platform.height;
                player.velY = 0;
            }
            // Side collisions
            else if (player.velX > 0 && player.x + player.width > platform.x && player.x < platform.x) {
                player.x = platform.x - player.width;
            }
            else if (player.velX < 0 && player.x < platform.x + platform.width && player.x + player.width > platform.x + platform.width) {
                player.x = platform.x + platform.width;
            }
        }
    });
    
    // Jump-through platform collision
    if (!canJumpThrough || player.velY <= 0) {
        jumpThroughPlatforms.forEach(platform => {
            if (checkCollision(player, platform)) {
                // Only collide from top when not jumping through
                if (player.velY > 0 && player.y + player.height > platform.y && player.y < platform.y) {
                    player.y = platform.y - player.height;
                    player.velY = 0;
                    player.jumping = false;
                    onGround = true;
                }
            }
        });
    }
    
    // Update moving platforms
    jumpThroughPlatforms.forEach(platform => {
        if (platform.moving) {
            if (platform.moveX !== undefined) {
                platform.x = platform.originalX + Math.sin(Date.now() * 0.001 * platform.speed) * platform.moveX;
            }
            if (platform.moveY !== undefined) {
                platform.y = platform.originalY + Math.sin(Date.now() * 0.001 * platform.speed) * platform.moveY;
            }
        }
    });
    
    // Coin collection
    coins = coins.filter(coin => {
        if (checkCollision(player, coin)) {
            coinsCollected++;
            createParticles(coin.x + coin.width/2, coin.y + coin.height/2, 10, '#f1c40f');
            return false;
        }
        return true;
    });
    
    // Enemy collision
    enemies.forEach(enemy => {
        // Move enemy
        enemy.x += enemy.speed * enemy.direction;
        if (enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) {
            enemy.direction *= -1;
        }
        
        // Check collision with player
        if (checkCollision(player, enemy)) {
            player.health -= 10;
            player.velY = -8; // Knockback
            if (player.health <= 0) {
                gameOver = true;
            }
        }
    });
    
    // Check level completion (flag collision)
    const level = levels[currentLevel - 1];
    if (checkCollision(player, level.flag) && coins.length === 0) {
        levelComplete = true;
        document.getElementById('coinsCollected').textContent = coinsCollected;
        document.getElementById('totalCoins').textContent = totalCoins;
        document.getElementById('levelTime').textContent = Math.floor((Date.now() - levelStartTime) / 1000);
        document.getElementById('progressFill').style.width = '100%';
        showScreen('levelComplete');
    }
    
    // Check game over
    if (gameOver) {
        showScreen('gameOver');
    }
    
    updateStats();
}

function createParticles(x, y, count, color) {
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.background = color;
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        document.getElementById('gameContainer').appendChild(particle);
        
        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 3;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;
        
        let opacity = 1;
        const fade = setInterval(() => {
            opacity -= 0.05;
            particle.style.opacity = opacity;
            particle.style.left = (parseFloat(particle.style.left) + vx) + 'px';
            particle.style.top = (parseFloat(particle.style.top) + vy) + 'px';
            
            if (opacity <= 0) {
                clearInterval(fade);
                particle.remove();
            }
        }, 50);
    }
}

function drawCube(x, y, size, rotation) {
    ctx.save();
    ctx.translate(x + size/2, y + size/2);
    ctx.rotate(rotation);
    
    // Cube faces with gradient
    const gradient = ctx.createLinearGradient(-size/2, -size/2, size/2, size/2);
    gradient.addColorStop(0, '#3498db');
    gradient.addColorStop(1, '#2980b9');
    
    ctx.fillStyle = gradient;
    ctx.fillRect(-size/2, -size/2, size, size);
    
    // Cube edges
    ctx.strokeStyle = '#2c3e50';
    ctx.lineWidth = 2;
    ctx.strokeRect(-size/2, -size/2, size, size);
    
    // Cube face details
    ctx.fillStyle = '#2c3e50';
    ctx.fillRect(-size/4, -size/4, size/2, size/2);
    
    ctx.restore();
}

function drawGame() {
    // Clear canvas
    ctx.fillStyle = '#87CEEB';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Draw background elements
    ctx.fillStyle = '#98FB98';
    ctx.fillRect(0, 500, canvas.width, 100);
    
    // Draw solid platforms
    ctx.fillStyle = '#8B4513';
    platforms.forEach(platform => {
        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        ctx.strokeStyle = '#654321';
        ctx.lineWidth = 2;
        ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
    });
    
    // Draw jump-through platforms (semi-transparent)
    ctx.fillStyle = 'rgba(139, 69, 19, 0.7)';
    jumpThroughPlatforms.forEach(platform => {
        ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
        ctx.strokeStyle = '#654321';
        ctx.lineWidth = 2;
        ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
        
        // Dashed line to indicate jump-through
        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = '#f1c40f';
        ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
        ctx.setLineDash([]);
    });
    
    // Draw coins
    ctx.fillStyle = '#f1c40f';
    coins.forEach(coin => {
        ctx.beginPath();
        ctx.arc(coin.x + coin.width/2, coin.y + coin.height/2, coin.width/2, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#d35400';
        ctx.lineWidth = 2;
        ctx.stroke();
    });
    
    // Draw enemies
    enemies.forEach(enemy => {
        ctx.fillStyle = enemy.boss ? '#e74c3c' : '#c0392b';
        ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        ctx.fillStyle = '#2c3e50';
        ctx.fillRect(enemy.x + 5, enemy.y + 5, 8, 8);
        ctx.fillRect(enemy.x + enemy.width - 13, enemy.y + 5, 8, 8);
    });
    
    // Draw player as rotating cube
    drawCube(player.x, player.y, player.width, player.rotation);
    
    // Draw flag
    const level = levels[currentLevel - 1];
    ctx.fillStyle = '#e74c3c';
    ctx.fillRect(level.flag.x, level.flag.y, level.flag.width, level.flag.height);
    ctx.fillStyle = '#f1c40f';
    ctx.beginPath();
    ctx.moveTo(level.flag.x + level.flag.width, level.flag.y);
    ctx.lineTo(level.flag.x + level.flag.width + 20, level.flag.y + 15);
    ctx.lineTo(level.flag.x + level.flag.width, level.flag.y + 30);
    ctx.fill();
    
    // Flag pole details
    ctx.fillStyle = '#7f8c8d';
    ctx.fillRect(level.flag.x - 5, level.flag.y, 5, level.flag.height);
}

function gameLoop() {
    if (!levelComplete && !gameOver) {
        updateGame();
        drawGame();
        requestAnimationFrame(gameLoop);
    }
}

// Input Handling
const keys = {};

window.addEventListener('keydown', (e) => {
    keys[e.key] = true;
    
    if (e.key === 'r') {
        restartLevel();
    }
    if (e.key === 'm') {
        showMainMenu();
    }
    if (e.key === ' ' && !player.jumping) {
        player.velY = PLAYER_JUMP;
        player.jumping = true;
    }
    if (e.key === 'ArrowDown') {
        canJumpThrough = true;
    }
});

window.addEventListener('keyup', (e) => {
    keys[e.key] = false;
    
    if (e.key === 'ArrowDown') {
        canJumpThrough = false;
    }
});

function handleInput() {
    player.velX = 0;
    
    if (keys['ArrowLeft'] || keys['a']) {
        player.velX = -PLAYER_SPEED;
    }
    if (keys['ArrowRight'] || keys['d']) {
        player.velX = PLAYER_SPEED;
    }
}

setInterval(handleInput, 1000/60);

// Initialize level select
updateLevelSelector();
showMainMenu();

// Add some visual effects
setInterval(() => {
    document.querySelectorAll('.glow').forEach(element => {
        element.style.textShadow = `0 0 ${10 + Math.random() * 10}px #f1c40f, 0 0 ${20 + Math.random() * 10}px #f1c40f`;
    });
}, 2000);
</script>
</body>
</html>
